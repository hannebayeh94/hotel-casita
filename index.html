<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Hotel y Restaurante Mi Casita B&V</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .sub-tab-active {
            background-color: #3b82f6;
            color: white;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .action-btn {
            padding: 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover {
            background-color: #e5e7eb;
        }
        .action-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600 font-semibold">Conectando...</p>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-40 hidden items-center justify-center bg-gray-100">
        <div class="w-full max-w-sm p-8 bg-white rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Bienvenido</h2>
            <p class="text-center text-gray-500 mb-6">Inicia sesión para administrar el hotel</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Iniciar Sesión
                </button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-xl sm:text-2xl font-bold text-blue-600">Hotel y Restaurante Mi Casita B&V</h1>
                    <div class="flex items-center gap-4">
                        <div id="current-time" class="text-sm text-gray-500 hidden sm:block"></div>
                        <button id="logout-btn" class="text-sm font-semibold text-red-600 hover:text-red-800">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex border-b border-gray-200">
                    <button data-tab="reservas" class="tab-btn py-4 px-6 block hover:text-blue-500 focus:outline-none tab-active">Reservas</button>
                    <button data-tab="habitaciones" class="tab-btn py-4 px-6 block hover:text-blue-500 focus:outline-none">Habitaciones</button>
                    <button data-tab="huespedes" class="tab-btn py-4 px-6 block hover:text-blue-500 focus:outline-none">Huéspedes</button>
                    <button data-tab="reportes" class="tab-btn py-4 px-6 block hover:text-blue-500 focus:outline-none">Reportes</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Reservas Section -->
            <div id="reservas-section" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Gestión de Reservas</h2>
                    <button id="add-reservation-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Nueva Reserva</span>
                    </button>
                </div>
                <!-- Reservation Sub-tabs -->
                <div class="mb-6">
                    <div class="bg-gray-200 rounded-lg p-1 flex w-full sm:w-auto">
                        <button data-subtab="activas" class="sub-tab-btn w-full text-center px-4 py-2 rounded-md text-sm font-semibold sub-tab-active">Activas y Próximas</button>
                        <button data-subtab="completadas" class="sub-tab-btn w-full text-center px-4 py-2 rounded-md text-sm font-semibold">Completadas</button>
                    </div>
                </div>

                <!-- Active Reservations Table -->
                <div id="activas-subcontent" class="sub-tab-content bg-white p-6 rounded-lg shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-4">Habitación</th>
                                    <th class="p-4">Huésped</th>
                                    <th class="p-4">Check-in/Out</th>
                                    <th class="p-4">Total</th>
                                    <th class="p-4">Pagado</th>
                                    <th class="p-4">Saldo</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reservations-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Completed Reservations Table -->
                <div id="completadas-subcontent" class="sub-tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-4">Habitación</th>
                                    <th class="p-4">Huésped</th>
                                    <th class="p-4">Check-in/Out</th>
                                    <th class="p-4">Total Pagado</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="completed-reservations-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Habitaciones Section -->
            <div id="habitaciones-section" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Gestión de Habitaciones</h2>
                    <button id="add-room-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>Nueva Habitación</span>
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-4">Número</th>
                                    <th class="p-4">Tipo/Nombre</th>
                                    <th class="p-4">Precio/Noche</th>
                                    <th class="p-4">Estado</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rooms-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Huéspedes Section -->
            <div id="huespedes-section" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Registro de Huéspedes</h2>
                    <button id="add-guest-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 11a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1v-1z" /></svg>
                        <span>Nuevo Huésped</span>
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-4">Nombre</th>
                                    <th class="p-4">Documento</th>
                                    <th class="p-4">Teléfono</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="guests-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reportes Section -->
            <div id="reportes-section" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Reporte Mensual de Ingresos</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap gap-4 items-center mb-6">
                        <div>
                            <label for="report-month" class="block text-sm font-medium text-gray-700">Mes</label>
                            <select id="report-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="report-year" class="block text-sm font-medium text-gray-700">Año</label>
                            <select id="report-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                        </div>
                        <button id="generate-report-btn" class="self-end bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Generar Reporte</button>
                        <button id="download-report-btn" class="self-end bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">Descargar CSV</button>
                    </div>
                    <div id="report-output"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Room Modal -->
    <div id="room-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="room-form" class="p-6">
                <h3 id="room-modal-title" class="text-xl font-bold mb-4">Nueva Habitación</h3>
                <input type="hidden" id="room-id">
                <div class="mb-4">
                    <label for="room-number" class="block text-sm font-medium text-gray-700">Número de Habitación</label>
                    <select id="room-number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></select>
                </div>
                <div class="mb-4">
                    <label for="room-name" class="block text-sm font-medium text-gray-700">Tipo de Habitación</label>
                    <select id="room-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="Sencilla">Sencilla</option>
                        <option value="Doble">Doble</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="room-price" class="block text-sm font-medium text-gray-700">Precio por Noche (COP)</label>
                    <input type="number" id="room-price" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <div id="price-suggestions" class="mt-2 flex flex-wrap gap-2">
                        <button type="button" data-price="15000" class="price-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300">15.000</button>
                        <button type="button" data-price="20000" class="price-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300">20.000</button>
                        <button type="button" data-price="25000" class="price-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300">25.000</button>
                        <button type="button" data-price="30000" class="price-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300">30.000</button>
                        <button type="button" data-price="35000" class="price-btn bg-gray-200 text-gray-700 text-xs font-semibold py-1 px-3 rounded-full hover:bg-gray-300">35.000</button>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-room-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Guest Modal -->
    <div id="guest-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="guest-form" class="p-6">
                <h3 id="guest-modal-title" class="text-xl font-bold mb-4">Nuevo Huésped</h3>
                <input type="hidden" id="guest-id">
                <div class="mb-4">
                    <label for="guest-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="guest-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="guest-doc" class="block text-sm font-medium text-gray-700">Número de Documento (Opcional)</label>
                    <input type="text" id="guest-doc" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="guest-phone" class="block text-sm font-medium text-gray-700">Teléfono (Opcional)</label>
                    <input type="tel" id="guest-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-guest-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reservation Modal -->
    <div id="reservation-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <form id="reservation-form" class="p-6">
                <h3 id="reservation-modal-title" class="text-xl font-bold mb-4">Nueva Reserva</h3>
                <input type="hidden" id="reservation-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reservation-room" class="block text-sm font-medium text-gray-700">Habitación</label>
                        <select id="reservation-room" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></select>
                    </div>
                    <div>
                        <label for="reservation-guest" class="block text-sm font-medium text-gray-700">Huésped</label>
                        <select id="reservation-guest" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></select>
                    </div>
                    <div>
                        <label for="reservation-checkin" class="block text-sm font-medium text-gray-700">Fecha de Check-in</label>
                        <input type="date" id="reservation-checkin" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="reservation-checkout" class="block text-sm font-medium text-gray-700">Fecha de Check-out (Opcional)</label>
                        <input type="date" id="reservation-checkout" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="payment-section" class="md:col-span-2">
                         <label for="reservation-payment" class="block text-sm font-medium text-gray-700">Abono Inicial (COP)</label>
                        <input type="number" id="reservation-payment" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                    </div>
                    <div class="md:col-span-2">
                        <label for="reservation-comments" class="block text-sm font-medium text-gray-700">Comentarios / Instrucciones Especiales (Personal)</label>
                        <textarea id="reservation-comments" rows="3" maxlength="300" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-reservation-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Reserva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4">Gestionar Pagos</h3>
                <input type="hidden" id="payment-reservation-id">
                <div class="mb-4">
                    <h4 class="font-semibold">Historial de Pagos</h4>
                    <ul id="payment-history" class="mt-2 text-sm list-disc list-inside bg-gray-50 p-3 rounded-md"></ul>
                </div>
                <form id="add-payment-form" class="space-y-4">
                    <div>
                        <label for="new-payment-amount" class="block text-sm font-medium text-gray-700">Nuevo Abono (COP)</label>
                        <input type="number" id="new-payment-amount" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="button" id="pay-remaining-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Pagar Saldo Restante</button>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Agregar Pago</button>
                </form>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-payment-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 text-center">
            <h3 class="text-xl font-bold mb-4">Confirmar Eliminación</h3>
            <p id="delete-modal-text" class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar este elemento? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notes-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                 <div class="flex justify-between items-start">
                    <h3 id="notes-modal-title" class="text-xl font-bold mb-4 text-gray-800">Notas de la Reserva</h3>
                    <button id="close-notes-modal-x" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <div id="notes-modal-content" class="mt-2 text-gray-600 bg-gray-50 p-4 rounded-md whitespace-pre-wrap"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-notes-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mark as Paid Confirmation Modal -->
    <div id="mark-paid-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 p-6">
            <h3 class="text-xl font-bold mb-2">Completar y Cerrar Reserva</h3>
            <p class="text-gray-600 mb-4">Estás a punto de marcar esta reserva como pagada y completada. Esta acción no se puede deshacer fácilmente.</p>
            <div id="mark-paid-summary" class="bg-gray-50 p-4 rounded-lg mb-6 text-sm"></div>
            <div class="flex justify-end gap-4">
                <button id="cancel-mark-paid-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-mark-paid-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Confirmar y Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 z-50">
        <p id="toast-message"></p>
    </div>

<script type="module">
    // Importa las funciones de Firebase que necesitas
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Tu configuración de Firebase que proporcionaste
    const firebaseConfig = {
        apiKey: "AIzaSyC-ckcRfFO5hKSbtevfQxlUNHN_4Yfji2I",
        authDomain: "hotel-mi-casita-admin.firebaseapp.com",
        projectId: "hotel-mi-casita-admin",
        storageBucket: "hotel-mi-casita-admin.firebasestorage.app",
        messagingSenderId: "998696691546",
        appId: "1:998696691546:web:a741f47300ff7dee1d3563"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- ICONS ---
    const ICONS = {
        edit: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`,
        payment: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" /></svg>`,
        notes: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72-3.72a1.066 1.066 0 010-1.506l3.72-3.72a1.066 1.066 0 011.506 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193l-3.72-3.72a1.066 1.066 0 010-1.506l3.72-3.72a1.066 1.066 0 011.506 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>`,
        trash: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`,
        markPaid: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
    };

    // --- STATE MANAGEMENT ---
    let state = {
        rooms: [],
        guests: [],
        reservations: [],
        deletingItem: { type: null, id: null },
        completingReservationId: null
    };

    // --- DOM ELEMENTS ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');
    const subTabs = document.querySelectorAll('.sub-tab-btn');
    const subContents = document.querySelectorAll('.sub-tab-content');
    const currentTimeEl = document.getElementById('current-time');

    // Modals
    const roomModal = document.getElementById('room-modal');
    const guestModal = document.getElementById('guest-modal');
    const reservationModal = document.getElementById('reservation-modal');
    const paymentModal = document.getElementById('payment-modal');
    const deleteModal = document.getElementById('delete-modal');
    const notesModal = document.getElementById('notes-modal');
    const markPaidModal = document.getElementById('mark-paid-modal');

    // Forms
    const loginForm = document.getElementById('login-form');
    const roomForm = document.getElementById('room-form');
    const guestForm = document.getElementById('guest-form');
    const reservationForm = document.getElementById('reservation-form');
    const addPaymentForm = document.getElementById('add-payment-form');

    // Tables
    const roomsTableBody = document.getElementById('rooms-table-body');
    const guestsTableBody = document.getElementById('guests-table-body');
    const reservationsTableBody = document.getElementById('reservations-table-body');
    const completedReservationsTableBody = document.getElementById('completed-reservations-table-body');

    // Report elements
    const reportMonthSelect = document.getElementById('report-month');
    const reportYearSelect = document.getElementById('report-year');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const downloadReportBtn = document.getElementById('download-report-btn');
    const reportOutput = document.getElementById('report-output');

    // --- UTILS ---
    const formatCOP = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
    const getTodayDate = () => new Date().toISOString().split('T')[0];

    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.classList.remove('bg-green-500', 'bg-red-500');
        toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        toast.classList.remove('opacity-0');
        setTimeout(() => {
            toast.classList.add('opacity-0');
        }, 3000);
    };

    const calculateBalance = (reservation) => {
        if (!reservation) return 0;
        const room = state.rooms.find(r => r.id === reservation.roomId);
        if (!room) return 0;

        const checkin = new Date(reservation.checkinDate + 'T00:00:00');
        const checkoutDate = reservation.checkoutDate ? reservation.checkoutDate : getTodayDate();
        const checkout = new Date(checkoutDate + 'T00:00:00');
        const nights = Math.max(1, Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24)));
        
        const totalCost = nights * room.price;
        const totalPaid = reservation.payments.reduce((sum, p) => sum + p.amount, 0);
        return totalCost - totalPaid;
    }

    // --- RENDER FUNCTIONS ---
    const renderAll = () => {
        updateRoomStatuses();
        renderRooms();
        renderGuests();
        renderReservations();
    };

    const renderRooms = () => {
        roomsTableBody.innerHTML = '';
        if (state.rooms.length === 0) {
            roomsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No hay habitaciones registradas.</td></tr>`;
            return;
        }
        state.rooms.sort((a, b) => a.number - b.number).forEach(room => {
            const statusClasses = { 'Disponible': 'bg-green-100 text-green-800', 'Ocupada': 'bg-red-100 text-red-800', 'Mantenimiento': 'bg-yellow-100 text-yellow-800' };
            const row = `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium">${room.number}</td>
                    <td class="p-4">${room.name}</td>
                    <td class="p-4">${formatCOP(room.price)}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClasses[room.status] || ''}">${room.status}</span></td>
                    <td class="p-4">
                        <div class="flex items-center justify-center gap-1">
                            <button title="Editar" class="edit-room-btn action-btn text-blue-600" data-id="${room.id}">${ICONS.edit}</button>
                            <button title="Eliminar" class="delete-room-btn action-btn text-red-600" data-id="${room.id}">${ICONS.trash}</button>
                        </div>
                    </td>
                </tr>`;
            roomsTableBody.innerHTML += row;
        });
    };

    const renderGuests = () => {
        guestsTableBody.innerHTML = '';
        if (state.guests.length === 0) {
            guestsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">No hay huéspedes registrados.</td></tr>`;
            return;
        }
        state.guests.forEach(guest => {
            const row = `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium">${guest.name}</td>
                    <td class="p-4">${guest.doc || 'N/A'}</td>
                    <td class="p-4">${guest.phone || 'N/A'}</td>
                    <td class="p-4">
                        <div class="flex items-center justify-center gap-1">
                            <button title="Editar" class="edit-guest-btn action-btn text-blue-600" data-id="${guest.id}">${ICONS.edit}</button>
                            <button title="Eliminar" class="delete-guest-btn action-btn text-red-600" data-id="${guest.id}">${ICONS.trash}</button>
                        </div>
                    </td>
                </tr>`;
            guestsTableBody.innerHTML += row;
        });
    };

    const renderReservations = () => {
        reservationsTableBody.innerHTML = '';
        completedReservationsTableBody.innerHTML = '';
        
        const activeReservations = state.reservations.filter(r => r.status === 'active');
        const completedReservations = state.reservations.filter(r => r.status === 'completed');

        if (activeReservations.length === 0) {
            reservationsTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No hay reservas activas.</td></tr>`;
        } else {
            activeReservations.sort((a, b) => new Date(a.checkinDate) - new Date(b.checkinDate)).forEach(res => reservationsTableBody.innerHTML += createReservationRow(res, 'active'));
        }

        if (completedReservations.length === 0) {
            completedReservationsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No hay reservas completadas.</td></tr>`;
        } else {
            completedReservations.sort((a, b) => new Date(b.checkoutDate) - new Date(a.checkoutDate)).forEach(res => completedReservationsTableBody.innerHTML += createReservationRow(res, 'completed'));
        }
    };
    
    const createReservationRow = (res, type) => {
        const room = state.rooms.find(r => r.id === res.roomId);
        const guest = state.guests.find(g => g.id === res.guestId);
        if (!room || !guest) return '';

        const balance = calculateBalance(res);
        const totalPaid = res.payments.reduce((sum, p) => sum + p.amount, 0);
        const totalCost = totalPaid + balance;

        const dateRange = `
            <div class="flex flex-col">
                <span class="font-medium">${res.checkinDate}</span>
                <span class="text-xs text-gray-500">${res.checkoutDate || 'Indefinido'}</span>
            </div>`;

        if (type === 'active') {
            const markPaidButton = res.checkoutDate ? `<button title="Finalizar y Pagar Saldo" class="mark-paid-btn action-btn text-green-600" data-id="${res.id}">${ICONS.markPaid}</button>` : '';
            const notesButton = res.comments ? `<button title="Ver Notas" class="view-notes-btn action-btn text-purple-600" data-id="${res.id}">${ICONS.notes}</button>` : '';
            
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4"><div class="font-medium">${room.number}</div><div class="text-xs text-gray-500">${room.name}</div></td>
                    <td class="p-4">${guest.name}</td>
                    <td class="p-4">${dateRange}</td>
                    <td class="p-4">${formatCOP(totalCost)}</td>
                    <td class="p-4 text-green-600">${formatCOP(totalPaid)}</td>
                    <td class="p-4 font-semibold ${balance > 0 ? 'text-red-600' : 'text-gray-800'}">${formatCOP(balance)}</td>
                    <td class="p-4">
                        <div class="flex items-center justify-center gap-1">
                            <button title="Editar" class="edit-reservation-btn action-btn text-blue-600" data-id="${res.id}">${ICONS.edit}</button>
                            <button title="Gestionar Pagos" class="manage-payment-btn action-btn text-yellow-600" data-id="${res.id}">${ICONS.payment}</button>
                            ${notesButton}
                            ${markPaidButton}
                            <button title="Eliminar" class="delete-reservation-btn action-btn text-red-600" data-id="${res.id}">${ICONS.trash}</button>
                        </div>
                    </td>
                </tr>`;
        }

        if (type === 'completed') {
            const notesButton = res.comments ? `<button title="Ver Notas" class="view-notes-btn action-btn text-purple-600" data-id="${res.id}">${ICONS.notes}</button>` : '';
            return `
                <tr class="border-b hover:bg-gray-50 bg-gray-50 text-gray-600">
                    <td class="p-4"><div class="font-medium">${room.number}</div><div class="text-xs">${room.name}</div></td>
                    <td class="p-4">${guest.name}</td>
                    <td class="p-4">${dateRange}</td>
                    <td class="p-4 font-medium">${formatCOP(totalPaid)}</td>
                    <td class="p-4">
                        <div class="flex items-center justify-center gap-1">
                            ${notesButton}
                        </div>
                    </td>
                </tr>`;
        }
    };
    
    const updateRoomStatuses = () => {
        state.rooms.forEach(room => {
            const activeReservation = state.reservations.find(res => res.roomId === room.id && res.status === 'active');
            room.status = activeReservation ? 'Ocupada' : 'Disponible';
        });
        renderRooms(); // Re-render rooms to show status changes
    };

    // --- MODAL & FORM HANDLING ---
    const openModal = (modal) => modal.style.display = 'flex';
    const closeModal = (modal) => modal.style.display = 'none';

    // Generic modal closers
    ['cancel-room-modal', 'cancel-guest-modal', 'cancel-reservation-modal', 'close-payment-modal', 'cancel-delete-btn', 'close-notes-modal-x', 'close-notes-modal-btn', 'cancel-mark-paid-btn'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => {
            closeModal(document.getElementById(id).closest('.modal-backdrop'));
        });
    });

    const openRoomModalForNew = () => {
        roomForm.reset();
        document.getElementById('room-modal-title').textContent = 'Nueva Habitación';
        document.getElementById('room-id').value = '';

        const roomNumberSelect = document.getElementById('room-number');
        roomNumberSelect.disabled = false;
        roomNumberSelect.innerHTML = '';

        const existingRoomNumbers = state.rooms.map(r => r.number);
        const availableNumbers = [];
        for (let i = 1; i <= 20; i++) {
            if (!existingRoomNumbers.includes(i)) {
                availableNumbers.push(i);
            }
        }

        if (availableNumbers.length === 0) {
            showToast('No hay números de habitación disponibles.', true);
            return;
        }

        availableNumbers.forEach(num => {
            const option = document.createElement('option');
            option.value = num;
            option.textContent = num;
            roomNumberSelect.appendChild(option);
        });

        openModal(roomModal);
    };

    const openRoomModalForEdit = (room) => {
        roomForm.reset();
        document.getElementById('room-modal-title').textContent = 'Editar Habitación';
        document.getElementById('room-id').value = room.id;
        
        const roomNumberSelect = document.getElementById('room-number');
        roomNumberSelect.innerHTML = `<option value="${room.number}">${room.number}</option>`;
        roomNumberSelect.disabled = true;

        document.getElementById('room-name').value = room.name;
        document.getElementById('room-price').value = room.price;
        openModal(roomModal);
    };

    document.getElementById('add-room-btn').addEventListener('click', openRoomModalForNew);

    document.getElementById('price-suggestions').addEventListener('click', (e) => {
        const target = e.target.closest('.price-btn');
        if (target) {
            document.getElementById('room-price').value = target.dataset.price;
        }
    });

    document.getElementById('add-guest-btn').addEventListener('click', () => {
        guestForm.reset();
        document.getElementById('guest-modal-title').textContent = 'Nuevo Huésped';
        document.getElementById('guest-id').value = '';
        openModal(guestModal);
    });

    document.getElementById('add-reservation-btn').addEventListener('click', () => {
        reservationForm.reset();
        document.getElementById('reservation-modal-title').textContent = 'Nueva Reserva';
        document.getElementById('reservation-id').value = '';
        document.getElementById('payment-section').classList.remove('hidden');
        populateReservationDropdowns();
        document.getElementById('reservation-checkin').value = getTodayDate();
        openModal(reservationModal);
    });

    const populateReservationDropdowns = (editingReservation = null) => {
        const roomSelect = document.getElementById('reservation-room');
        const guestSelect = document.getElementById('reservation-guest');
        
        roomSelect.innerHTML = '<option value="">Seleccione una habitación</option>';
        const availableRooms = state.rooms.filter(r => r.status === 'Disponible' || (editingReservation && r.id === editingReservation.roomId));
        availableRooms.sort((a, b) => a.number - b.number).forEach(room => {
            roomSelect.innerHTML += `<option value="${room.id}">${room.number} - ${room.name}</option>`;
        });

        guestSelect.innerHTML = '<option value="">Seleccione un huésped</option>';
        state.guests.forEach(guest => {
            guestSelect.innerHTML += `<option value="${guest.id}">${guest.name}</option>`;
        });
    };

    // --- FIRESTORE CRUD OPERATIONS ---
    // Room
    roomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('room-id').value;
        const roomData = { 
            number: parseInt(document.getElementById('room-number').value), 
            name: document.getElementById('room-name').value, 
            price: parseFloat(document.getElementById('room-price').value) 
        };

        try {
            if (id) {
                const { number, ...updatableData } = roomData;
                const roomRef = doc(db, "rooms", id);
                await updateDoc(roomRef, updatableData);
                showToast('Habitación actualizada con éxito.');
            } else {
                if (state.rooms.some(r => r.number === roomData.number)) { showToast('El número de habitación ya existe.', true); return; }
                await addDoc(collection(db, "rooms"), { ...roomData, status: 'Disponible' });
                showToast('Habitación creada con éxito.');
            }
            closeModal(roomModal);
        } catch (error) {
            console.error("Error saving room: ", error);
            showToast('Error al guardar la habitación.', true);
        }
    });

    // Guest
    guestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('guest-id').value;
        const guestData = { name: document.getElementById('guest-name').value.trim(), doc: document.getElementById('guest-doc').value.trim(), phone: document.getElementById('guest-phone').value.trim() };
        
        try {
            if (id) {
                await updateDoc(doc(db, "guests", id), guestData);
                showToast('Huésped actualizado con éxito.');
            } else {
                await addDoc(collection(db, "guests"), guestData);
                showToast('Huésped creado con éxito.');
            }
            closeModal(guestModal);
        } catch (error) {
            console.error("Error saving guest: ", error);
            showToast('Error al guardar el huésped.', true);
        }
    });
    
    // Reservation
    reservationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('reservation-id').value;
        const reservationData = {
            roomId: document.getElementById('reservation-room').value,
            guestId: document.getElementById('reservation-guest').value,
            checkinDate: document.getElementById('reservation-checkin').value,
            checkoutDate: document.getElementById('reservation-checkout').value || null,
            comments: document.getElementById('reservation-comments').value.trim()
        };
        if (!reservationData.roomId || !reservationData.guestId || !reservationData.checkinDate) { showToast('Habitación, huésped y fecha de check-in son obligatorios.', true); return; }
        
        try {
            if (id) {
                await updateDoc(doc(db, "reservations", id), reservationData);
                showToast('Reserva actualizada con éxito.');
            } else {
                const paymentAmount = parseFloat(document.getElementById('reservation-payment').value) || 0;
                const newReservation = {
                    ...reservationData,
                    status: 'active',
                    payments: paymentAmount > 0 ? [{ amount: paymentAmount, date: getTodayDate() }] : []
                };
                await addDoc(collection(db, "reservations"), newReservation);
                showToast('Reserva creada con éxito.');
            }
            closeModal(reservationModal);
        } catch (error) {
            console.error("Error saving reservation: ", error);
            showToast('Error al guardar la reserva.', true);
        }
    });

    // --- EVENT DELEGATION FOR DYNAMIC BUTTONS ---
    document.body.addEventListener('click', (e) => {
        const targetButton = e.target.closest('button');
        if (!targetButton) return;

        const id = targetButton.dataset.id;
        
        if (targetButton.classList.contains('edit-room-btn')) {
            const room = state.rooms.find(r => r.id === id);
            if (room) openRoomModalForEdit(room);
        }
        else if (targetButton.classList.contains('delete-room-btn')) {
            if (state.reservations.some(res => res.roomId === id && res.status === 'active')) { showToast('No se puede eliminar una habitación con una reserva activa.', true); return; }
            state.deletingItem = { type: 'rooms', id };
            document.getElementById('delete-modal-text').textContent = '¿Seguro que quieres eliminar esta habitación?';
            openModal(deleteModal);
        }
        else if (targetButton.classList.contains('edit-guest-btn')) {
            const guest = state.guests.find(g => g.id === id);
            if (guest) {
                document.getElementById('guest-modal-title').textContent = 'Editar Huésped';
                document.getElementById('guest-id').value = guest.id;
                document.getElementById('guest-name').value = guest.name;
                document.getElementById('guest-doc').value = guest.doc;
                document.getElementById('guest-phone').value = guest.phone;
                openModal(guestModal);
            }
        }
        else if (targetButton.classList.contains('delete-guest-btn')) {
            if (state.reservations.some(res => res.guestId === id && res.status === 'active')) { showToast('No se puede eliminar un huésped con una reserva activa.', true); return; }
            state.deletingItem = { type: 'guests', id };
            document.getElementById('delete-modal-text').textContent = '¿Seguro que quieres eliminar este huésped?';
            openModal(deleteModal);
        }
        else if (targetButton.classList.contains('edit-reservation-btn')) {
            const reservation = state.reservations.find(r => r.id === id);
            if (reservation) {
                populateReservationDropdowns(reservation);
                document.getElementById('reservation-modal-title').textContent = 'Editar Reserva';
                document.getElementById('reservation-id').value = reservation.id;
                document.getElementById('reservation-room').value = reservation.roomId;
                document.getElementById('reservation-guest').value = reservation.guestId;
                document.getElementById('reservation-checkin').value = reservation.checkinDate;
                document.getElementById('reservation-checkout').value = reservation.checkoutDate;
                document.getElementById('reservation-comments').value = reservation.comments || '';
                document.getElementById('payment-section').classList.add('hidden');
                openModal(reservationModal);
            }
        }
        else if (targetButton.classList.contains('delete-reservation-btn')) {
            state.deletingItem = { type: 'reservations', id };
            document.getElementById('delete-modal-text').textContent = '¿Seguro que quieres eliminar esta reserva?';
            openModal(deleteModal);
        }
        else if (targetButton.classList.contains('manage-payment-btn')) {
            const reservation = state.reservations.find(r => r.id === id);
            if (reservation) {
                document.getElementById('payment-reservation-id').value = id;
                const paymentHistoryEl = document.getElementById('payment-history');
                paymentHistoryEl.innerHTML = '';
                if (reservation.payments.length === 0) {
                    paymentHistoryEl.innerHTML = '<li>No hay pagos registrados.</li>';
                } else {
                    reservation.payments.forEach(p => { paymentHistoryEl.innerHTML += `<li>${formatCOP(p.amount)} - ${p.date}</li>`; });
                }
                openModal(paymentModal);
            }
        }
        else if (targetButton.classList.contains('view-notes-btn')) {
            const reservation = state.reservations.find(r => r.id === id);
            const guest = state.guests.find(g => g.id === reservation.guestId);
            if (reservation && guest) {
                document.getElementById('notes-modal-title').textContent = `Notas para ${guest.name}`;
                document.getElementById('notes-modal-content').textContent = reservation.comments;
                openModal(notesModal);
            }
        }
        else if (targetButton.classList.contains('mark-paid-btn')) {
            const reservation = state.reservations.find(r => r.id === id);
            if (reservation) {
                state.completingReservationId = id;
                const room = state.rooms.find(r => r.id === reservation.roomId);
                const guest = state.guests.find(g => g.id === reservation.guestId);
                const balance = calculateBalance(reservation);
                const totalPaid = reservation.payments.reduce((sum, p) => sum + p.amount, 0);
                const newTotalPaid = totalPaid + balance;

                document.getElementById('mark-paid-summary').innerHTML = `
                    <p><strong>Huésped:</strong> ${guest.name}</p>
                    <p><strong>Habitación:</strong> ${room.number} - ${room.name}</p>
                    <p><strong>Total Pagado Actual:</strong> ${formatCOP(totalPaid)}</p>
                    <p><strong>Saldo Pendiente a Pagar:</strong> <span class="font-bold text-red-600">${formatCOP(balance)}</span></p>
                    <hr class="my-2">
                    <p><strong>Nuevo Total Pagado:</strong> <span class="font-bold text-green-600">${formatCOP(newTotalPaid)}</span></p>
                `;
                openModal(markPaidModal);
            }
        }
    });

    document.getElementById('pay-remaining-btn').addEventListener('click', () => {
        const reservationId = document.getElementById('payment-reservation-id').value;
        const reservation = state.reservations.find(r => r.id === reservationId);
        if (reservation) {
            const balance = calculateBalance(reservation);
            if (balance > 0) {
                document.getElementById('new-payment-amount').value = balance;
            } else {
                showToast('La reserva no tiene saldo pendiente.');
            }
        }
    });

    addPaymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reservationId = document.getElementById('payment-reservation-id').value;
        const amount = parseFloat(document.getElementById('new-payment-amount').value);
        if (reservationId && amount > 0) {
            const reservation = state.reservations.find(r => r.id === reservationId);
            if (reservation) {
                const updatedPayments = [...reservation.payments, { amount, date: getTodayDate() }];
                try {
                    await updateDoc(doc(db, "reservations", reservationId), { payments: updatedPayments });
                    closeModal(paymentModal); 
                    addPaymentForm.reset(); 
                    showToast('Pago agregado con éxito.');
                } catch (error) {
                    console.error("Error adding payment: ", error);
                    showToast('Error al agregar el pago.', true);
                }
            }
        } else { showToast('Por favor, ingrese un monto válido.', true); }
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        const { type, id } = state.deletingItem;
        if (type && id) {
            try {
                await deleteDoc(doc(db, type, id));
                showToast(`Elemento eliminado con éxito.`);
            } catch (error) {
                console.error("Error deleting document: ", error);
                showToast('Error al eliminar el elemento.', true);
            }
        }
        closeModal(deleteModal); 
        state.deletingItem = { type: null, id: null };
    });
    
    document.getElementById('confirm-mark-paid-btn').addEventListener('click', async () => {
        const resId = state.completingReservationId;
        if (resId) {
            const reservation = state.reservations.find(r => r.id === resId);
            if (reservation) {
                const balance = calculateBalance(reservation);
                const updatedReservation = { status: 'completed' };
                if (balance > 0) {
                    updatedReservation.payments = [...reservation.payments, { amount: balance, date: getTodayDate() }];
                }
                if (!reservation.checkoutDate) {
                    updatedReservation.checkoutDate = getTodayDate();
                }

                try {
                    await updateDoc(doc(db, "reservations", resId), updatedReservation);
                    showToast('Reserva completada y cerrada.');
                } catch (error) {
                    console.error("Error completing reservation: ", error);
                    showToast('Error al completar la reserva.', true);
                }
            }
        }
        closeModal(markPaidModal);
        state.completingReservationId = null;
    });

    // --- TAB SWITCHING ---
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');
            contents.forEach(content => { content.id === `${target}-section` ? content.classList.remove('hidden') : content.classList.add('hidden'); });
        });
    });

    subTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.subtab;
            subTabs.forEach(t => t.classList.remove('sub-tab-active'));
            tab.classList.add('sub-tab-active');
            subContents.forEach(content => { content.id === `${target}-subcontent` ? content.classList.remove('hidden') : content.classList.add('hidden'); });
        });
    });

    // --- REPORTING ---
    const populateReportDates = () => {
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth();
        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        reportMonthSelect.innerHTML = months.map((m, i) => `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`).join('');
        reportYearSelect.innerHTML = '';
        for (let i = currentYear; i >= currentYear - 5; i--) { reportYearSelect.innerHTML += `<option value="${i}">${i}</option>`; }
    };

    generateReportBtn.addEventListener('click', () => {
        const month = parseInt(reportMonthSelect.value);
        const year = parseInt(reportYearSelect.value);
        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0);
        const paymentsInMonth = state.reservations.flatMap(res => res.payments.map(p => ({ ...p, reservation: res }))).filter(p => { const paymentDate = new Date(p.date + 'T00:00:00'); return paymentDate >= startDate && paymentDate <= endDate; });
        let totalIncome = 0;
        let reportHTML = `<h3 class="font-bold text-lg mb-4">Reporte para ${reportMonthSelect.options[month].text} ${year}</h3><div class="overflow-x-auto"><table class="w-full min-w-max text-left"><thead><tr class="border-b"><th class="p-2">Fecha Pago</th><th class="p-2">Monto</th><th class="p-2">Huésped</th><th class="p-2">Habitación</th></tr></thead><tbody>`;
        if (paymentsInMonth.length === 0) {
            reportHTML += `<tr><td colspan="4" class="text-center p-4 text-gray-500">No se registraron ingresos en este período.</td></tr>`;
        } else {
            paymentsInMonth.forEach(p => {
                const room = state.rooms.find(r => r.id === p.reservation.roomId);
                const guest = state.guests.find(g => g.id === p.reservation.guestId);
                totalIncome += p.amount;
                reportHTML += `<tr class="border-b"><td class="p-2">${p.date}</td><td class="p-2">${formatCOP(p.amount)}</td><td class="p-2">${guest ? guest.name : 'N/A'}</td><td class="p-2">${room ? room.number : 'N/A'}</td></tr>`;
            });
        }
        reportHTML += `</tbody><tfoot><tr class="border-t-2 font-bold"><td class="p-2">Total Ingresos:</td><td class="p-2" colspan="3">${formatCOP(totalIncome)}</td></tr></tfoot></table></div>`;
        reportOutput.innerHTML = reportHTML;
        paymentsInMonth.length > 0 ? downloadReportBtn.classList.remove('hidden') : downloadReportBtn.classList.add('hidden');
    });
    
    downloadReportBtn.addEventListener('click', () => {
        const month = parseInt(reportMonthSelect.value);
        const year = parseInt(reportYearSelect.value);
        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0);
        const paymentsInMonth = state.reservations.flatMap(res => res.payments.map(p => ({ ...p, reservation: res }))).filter(p => { const paymentDate = new Date(p.date + 'T00:00:00'); return paymentDate >= startDate && paymentDate <= endDate; });
        let csvContent = "data:text/csv;charset=utf-8,Fecha Pago,Monto,Huesped,Habitacion\n";
        let totalIncome = 0;
        paymentsInMonth.forEach(p => {
            const room = state.rooms.find(r => r.id === p.reservation.roomId);
            const guest = state.guests.find(g => g.id === p.reservation.guestId);
            totalIncome += p.amount;
            const row = [p.date, p.amount, `"${guest ? guest.name : 'N/A'}"`, `"${room ? room.number : 'N/A'}"`].join(",");
            csvContent += row + "\n";
        });
        csvContent += `\nTotal Ingresos,${totalIncome},,\n`;
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reporte_ingresos_${year}_${month + 1}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // --- INITIALIZATION ---
    const initApp = () => {
        appContainer.classList.remove('hidden');
        loadingOverlay.style.display = 'none';
        
        const updateTime = () => { currentTimeEl.textContent = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' }); };
        updateTime();
        setInterval(updateTime, 1000 * 60);
        populateReportDates();
        
        // Setup real-time listeners
        onSnapshot(collection(db, "rooms"), (snapshot) => {
            state.rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });
        onSnapshot(collection(db, "guests"), (snapshot) => {
            state.guests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderGuests();
            renderReservations();
        });
        onSnapshot(collection(db, "reservations"), (snapshot) => {
            state.reservations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderReservations();
            updateRoomStatuses();
        });
    };

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in.
            console.log("User authenticated with UID:", user.uid);
            loginScreen.style.display = 'none';
            initApp();
        } else {
            // User is signed out.
            loadingOverlay.style.display = 'none';
            appContainer.classList.add('hidden');
            loginScreen.style.display = 'flex';
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showToast('Inicio de sesión exitoso.');
        } catch (error) {
            console.error("Login failed:", error);
            showToast('Error: Usuario o contraseña incorrectos.', true);
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth).then(() => {
            showToast('Has cerrado la sesión.');
        }).catch((error) => {
            console.error('Sign out error', error);
            showToast('Error al cerrar sesión.', true);
        });
    });

</script>

</body>
</html>
